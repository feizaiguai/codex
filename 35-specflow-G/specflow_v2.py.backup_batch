"""
SpecFlow V2.0 - ä¸»å…¥å£
åŸå­çº§å¤šæ–‡æ¡£è§„æ ¼ç”Ÿæˆç³»ç»Ÿ
ç‰ˆæœ¬: 2.0.0

ä½¿ç”¨ç¤ºä¾‹:
    from specflow_v2 import generate_specification

    spec = generate_specification(
        task_description="æ„å»º B2B ç”µå•†å¹³å°,å¤šç§Ÿæˆ·,AI æ¨è...",
        metadata={
            "budget": 1200000,
            "timeline_months": 18,
            "team_size": 8
        }
    )

    # ä¿å­˜åˆ°æ–‡ä»¶
    save_specification(spec, output_dir="./output")
"""

from typing import Dict, Any, Optional, List, Tuple, Union, Callable
import os

# æ ¸å¿ƒæ¨¡å—å¯¼å…¥
from analyzer import TaskAnalyzer, TaskAnalysisResult
from atomic_component import (
    AtomicComponent, UserStory, Feature,
    ComponentCategory, Priority, AtomicProperty,
    UISpec, Interaction, EdgeCase, BDDScenario
)
from models_v2 import (
    SpecificationV2, DepthLevel, Document, DocumentType,
    BoundedContext, Aggregate, Risk, Milestone, WorkBreakdownStructure
)
from config_v2 import SpecFlowConfigV2
from validators import QualityValidator
from generators_extended import SpecificationGenerator


# ============ ä¸»ç”Ÿæˆå‡½æ•° ============

def generate_specification(
    """å¾…æ·»åŠ æ–‡æ¡£å­—ç¬¦ä¸²"""
    task_description: str,
    metadata: Optional[Dict[str, Any]] = None,
    depth_level: Optional[str] = None,
    output_dir: Optional[str] = None
) -> SpecificationV2:
    """
    ç”Ÿæˆå®Œæ•´çš„è§„æ ¼æ–‡æ¡£é›†(V2.0)

    Args:
        task_description: ä»»åŠ¡æè¿°
        metadata: å…ƒæ•°æ®(é¢„ç®—,æ—¶é—´çº¿,å›¢é˜Ÿè§„æ¨¡ç­‰)
        depth_level: æ·±åº¦çº§åˆ«("simple", "standard", "comprehensive")
                    å¦‚æœä¸æŒ‡å®š,å°†è‡ªåŠ¨æ¨è
        output_dir: è¾“å‡ºç›®å½•(å¦‚æœæŒ‡å®š,å°†è‡ªåŠ¨ä¿å­˜åˆ°æ–‡ä»¶)

    Returns:
        SpecificationV2: å®Œæ•´çš„è§„æ ¼æ–‡æ¡£é›†

    Example:
        >>> spec = generate_specification(
        ...     task_description="æ„å»º B2B ç”µå•†å¹³å°...",
        ...     metadata={"budget": 1200000, "timeline_months": 18}
        ... )
        >>> print(f"ç”Ÿæˆäº† {len(spec.documents)} ä¸ªæ–‡æ¡£")
        >>> print(f"è´¨é‡ç­‰çº§: {spec.quality_metrics.overall_grade.value}")
    """

    if metadata is None:
        metadata = {}

    print("ğŸš€ SpecFlow V2.0 - å¼€å§‹ç”ŸæˆåŸå­çº§è§„æ ¼æ–‡æ¡£")
    print("=" * 60)

    # 1. åˆ†æä»»åŠ¡
    print("\nğŸ“Š é˜¶æ®µ 1/4: åˆ†æä»»åŠ¡...")
    analysis_result = TaskAnalyzer.analyze(task_description, metadata)

    print(f"   - é¡¹ç›®åç§°: {analysis_result.project_name}")
    print(f"   - ä¼°ç®—å·¥æ—¶: {analysis_result.estimated_hours:.1f} å°æ—¶")
    print(f"   - å¤æ‚åº¦: {analysis_result.complexity_level}")
    print(f"   - æ¨èæ·±åº¦: {analysis_result.recommended_depth.value}")

    # 2. ç¡®å®šæ·±åº¦çº§åˆ«
    if depth_level:
        selected_depth = DepthLevel(depth_level)
        print(f"   - ä½¿ç”¨æŒ‡å®šæ·±åº¦: {selected_depth.value}")
    else:
        selected_depth = analysis_result.recommended_depth
        print(f"   - ä½¿ç”¨æ¨èæ·±åº¦: {selected_depth.value}")

    # 3. ä»åˆ†æç»“æœåˆ›å»ºåŸå­ç»„ä»¶(ç¤ºä¾‹)
    print("\nğŸ§© é˜¶æ®µ 2/4: åˆ›å»ºåŸå­çº§ç»„ä»¶...")
    components = _create_sample_components(analysis_result)
    print(f"   - åˆ›å»ºäº† {len(components)} ä¸ªåŸå­ç»„ä»¶")

    # 4. åˆ›å»ºç”¨æˆ·æ•…äº‹å’Œç‰¹æ€§(ç¤ºä¾‹)
    print("\nğŸ“ é˜¶æ®µ 3/4: åˆ›å»ºç”¨æˆ·æ•…äº‹å’Œç‰¹æ€§...")
    user_stories = _create_sample_user_stories(analysis_result, components)
    features = _create_sample_features(analysis_result, user_stories, components)
    print(f"   - åˆ›å»ºäº† {len(user_stories)} ä¸ªç”¨æˆ·æ•…äº‹")
    print(f"   - åˆ›å»ºäº† {len(features)} ä¸ªç‰¹æ€§")

    # 5. ç”Ÿæˆè§„æ ¼æ–‡æ¡£
    print("\nğŸ“„ é˜¶æ®µ 4/4: ç”Ÿæˆè§„æ ¼æ–‡æ¡£é›†...")
    config = SpecFlowConfigV2.MULTI_DOC_CONFIGS.get(
        selected_depth.value,
        SpecFlowConfigV2.MULTI_DOC_CONFIGS["standard"]
    )

    config["constraints"] = analysis_result.constraints

    generator = SpecificationGenerator(config)
    spec = generator.generate(
        project_name=analysis_result.project_name,
        task_description=task_description,
        analysis_result=analysis_result,
        components=components,
        user_stories=user_stories,
        features=features
    )

    print(f"   - ç”Ÿæˆäº† {len(spec.documents)} ä¸ªæ–‡æ¡£")
    print(f"   - æ€» Token: {spec.get_total_tokens():,}")
    print(f"   - Token ä½¿ç”¨ç‡: {spec.get_token_usage_percentage():.1f}%")

    # 6. è´¨é‡æŠ¥å‘Š
    print("\n è´¨é‡éªŒè¯:")
    if spec.quality_metrics:
        qm = spec.quality_metrics
        print(f"   - å®Œæ•´æ€§: {qm.completeness_score:.1f}/100")
        print(f"   - ä¸€è‡´æ€§: {qm.consistency_score:.1f}/100")
        print(f"   - åŸå­æ€§: {qm.atomicity_score:.1f}/100")
        print(f"   - å¯è¡Œæ€§: {qm.feasibility_score:.1f}/100")
        print(f"   - æ€»ä½“ç­‰çº§: {qm.overall_grade.value}")

    # 7. ä¿å­˜åˆ°æ–‡ä»¶(å¦‚æœæŒ‡å®š)
    if output_dir:
        print(f"\nğŸ’¾ ä¿å­˜åˆ°: {output_dir}")
        save_specification(spec, output_dir)

    print("\n" + "=" * 60)
    print("ğŸ‰ è§„æ ¼æ–‡æ¡£ç”Ÿæˆå®Œæˆ!")

    return spec


def save_specification(spec: SpecificationV2, output_dir: str):
    """
    
    
    Args:
        å‚æ•°å¾…æ–‡æ¡£åŒ–
    
    Returns:
        è¿”å›å€¼å¾…æ–‡æ¡£åŒ–
    """
    ä¿å­˜è§„æ ¼æ–‡æ¡£åˆ°æ–‡ä»¶ç³»ç»Ÿ

    Args:
        spec: è§„æ ¼å¯¹è±¡
        output_dir: è¾“å‡ºç›®å½•
    """
    generator = SpecificationGenerator({})
    generator.save_specification(spec, output_dir)


# ============ è¾…åŠ©å‡½æ•°(ç¤ºä¾‹ç”Ÿæˆ) ============

def _create_sample_components(analysis: TaskAnalysisResult) -> list[AtomicComponent]:
    """
    
    
    Args:
        å‚æ•°å¾…æ–‡æ¡£åŒ–
    
    Returns:
        è¿”å›å€¼å¾…æ–‡æ¡£åŒ–
    """
    åˆ›å»ºç¤ºä¾‹åŸå­ç»„ä»¶
    components = []

    # ä»åˆ†æç»“æœåˆ›å»ºä¸€äº›ç¤ºä¾‹ç»„ä»¶
    for i, entity in enumerate(analysis.key_entities[:5], 1):
        component = AtomicComponent(
            id=f"COMP-{i:03d}",
            name=f"{entity}Component",
            category=ComponentCategory.UI_COMPONENT,
            purpose=f"ç®¡ç†{entity}ç›¸å…³åŠŸèƒ½",
            context={"domain": analysis.identified_domains[0] if analysis.identified_domains else "æ ¸å¿ƒä¸šåŠ¡"},
            props=[
                AtomicProperty(
                    name="id",
                    type="string",
                    required=True,
                    description=f"{entity} å”¯ä¸€æ ‡è¯†",
                    validation=["UUID format"]
                )
            ],
            interactions=[
                Interaction(
                    event="create",
                    trigger="ç”¨æˆ·åˆ›å»ºæ“ä½œ",
                    result=f"åˆ›å»ºæ–°çš„{entity}"
                )
            ],
            edge_cases=[
                EdgeCase(
                    scenario="ç½‘ç»œé”™è¯¯",
                    handling="æ˜¾ç¤ºé‡è¯•æç¤º",
                    expected_behavior="ç”¨æˆ·å¯ä»¥é‡è¯•æ“ä½œ"
                )
            ],
            acceptance_criteria=[
                f"ç”¨æˆ·å¯ä»¥æˆåŠŸåˆ›å»º{entity}",
                f"{entity}æ•°æ®æ­£ç¡®ä¿å­˜"
            ],
            bdd_scenarios=[
                BDDScenario(
                    name=f"åˆ›å»º{entity}æˆåŠŸ",
                    given=[f"ç”¨æˆ·åœ¨{entity}ç®¡ç†é¡µé¢"],
                    when=[f"ç”¨æˆ·å¡«å†™{entity}ä¿¡æ¯å¹¶æäº¤"],
                    then=[f"{entity}åˆ›å»ºæˆåŠŸ", "æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯"]
                )
            ],
            priority=Priority.HIGH,
            estimated_hours=8.0,
            assigned_phase="MVP"
        )
        components.append(component)

    return components


def _create_sample_user_stories(
    """å¾…æ·»åŠ æ–‡æ¡£å­—ç¬¦ä¸²"""
    analysis: TaskAnalysisResult,
    components: list[AtomicComponent]
) -> list[UserStory]:
    """
    åˆ›å»ºç¤ºä¾‹ç”¨æˆ·æ•…äº‹
    stories = []

    for i in range(min(3, len(components))):
        story = UserStory(
            id=f"US-{i+1:03d}",
            title=f"ç”¨æˆ·æ•…äº‹ {i+1}",
            as_a="ç³»ç»Ÿç”¨æˆ·",
            i_want=f"ä½¿ç”¨{components[i].name}",
            so_that="æé«˜å·¥ä½œæ•ˆç‡",
            acceptance_criteria=components[i].acceptance_criteria,
            components=[components[i]],
            priority=Priority.HIGH,
            story_points=5
        )
        stories.append(story)

    return stories


def _create_sample_features(
    """å¾…æ·»åŠ æ–‡æ¡£å­—ç¬¦ä¸²"""
    analysis: TaskAnalysisResult,
    user_stories: list[UserStory],
    components: list[AtomicComponent]
) -> list[Feature]:
    """
    åˆ›å»ºç¤ºä¾‹ç‰¹æ€§
    features = []

    if user_stories:
        feature = Feature(
            id="F-1",
            name="æ ¸å¿ƒåŠŸèƒ½",
            description="é¡¹ç›®æ ¸å¿ƒåŠŸèƒ½é›†",
            value="Critical",
            complexity="High",
            user_stories=user_stories,
            components=components,
            estimated_hours=sum(c.estimated_hours for c in components)
        )
        features.append(feature)

    return features


# ============ å‘½ä»¤è¡Œæ¥å£ ============

def main():
    try:
        """
    
    
    Args:
        å‚æ•°å¾…æ–‡æ¡£åŒ–
    
    Returns:
        è¿”å›å€¼å¾…æ–‡æ¡£åŒ–
    """
    å‘½ä»¤è¡Œå…¥å£
    import sys

    if len(sys.argv) < 2:
        print("ä½¿ç”¨æ–¹æ³•: python specflow_v2.py <ä»»åŠ¡æè¿°>")
        print("ç¤ºä¾‹: python specflow_v2.py 'æ„å»º B2B ç”µå•†å¹³å°'")
        sys.exit(1)

    task_desc = " ".join(sys.argv[1:])

    spec = generate_specification(
        task_description=task_desc,
        output_dir="./output"
    )

    print(f"\nğŸ“Š è§„æ ¼æ‘˜è¦:")
    summary = spec.get_summary()
    for key, value in summary.items():
        print(f"   {key}: {value}")


if __name__ == "__main__":
    main()


# ============ ç‰ˆæœ¬ä¿¡æ¯ ============

__version__ = "2.0.0"
__author__ = "Claude (Sonnet 4.5)"
    except Exception as e:
        print(f"Error: {e}")
__description__ = "SpecFlow V2.0 - åŸå­çº§å¤šæ–‡æ¡£è§„æ ¼ç”Ÿæˆç³»ç»Ÿ"
