# 35-specflow 使用指南：三技能联动工作流

**版本**: V4.0
**更新时间**: 2025-12-21

---

## 快速开始

### 推荐使用方式（三技能联动）

```bash
cd C:\Users\bigbao\.claude\skills\35-specflow

# 使用V4（A+升级版，推荐）
python specflow_v4.py -i "../02-architecture/ARCHITECTURE.json" -o "output_v4/"

# 或使用V3（稳定版）
python specflow_json.py -i "../02-architecture/ARCHITECTURE.json" -o "output_v3/"
```

---

## 三种模式对比

### ⚠️ 重要：三种入口文件的区别

| 文件名 | 模式 | 输入 | 输出 | 何时使用 | 三技能联动 |
|--------|------|------|------|---------|-----------|
| **specflow.py** | 规则引擎 | 字符串（20-100词） | 基础文档 | 快速原型 | ❌ 不支持 |
| **specflow_json.py** | JSON驱动 V3 | JSON文件 | 8个规格文档 | 生产环境 | ✅ 支持 |
| **specflow_v4.py** | JSON驱动 V4 | JSON文件 | 8个规格文档 | 生产环境（A+版） | ✅ 支持 |

### 1️⃣ 规则引擎模式（specflow.py）

**特点**：
- ❌ 不支持JSON输入
- ❌ 不支持三技能联动
- ✅ 快速原型开发
- ✅ 简单需求场景

**使用场景**：
```bash
# 仅用于快速原型，不推荐生产使用
python specflow.py --task "开发一个博客系统" --domain "互联网" -o "output/"
```

**⚠️ 警告**：此模式**无法处理**来自01-spec-explorer或02-architecture的JSON文件！

---

### 2️⃣ JSON驱动模式 V3（specflow_json.py）

**特点**：
- ✅ 支持JSON输入
- ✅ 支持三技能联动（01→02→35）
- ✅ 生产环境稳定
- ✅ 完整的8个文档生成
- ✅ BDD场景集成

**使用场景**：
```bash
# 标准的三技能联动工作流
python specflow_json.py -i "../02-architecture/ARCHITECTURE.json" -o "output_v3/"

# 指定文档深度
python specflow_json.py -i ARCHITECTURE.json -o output/ --depth detailed
```

**支持的JSON输入**：
- `ARCHITECTURE.json`（来自02-architecture，**推荐**）
- `DESIGN_DRAFT.json`（来自01-spec-explorer）

---

### 3️⃣ JSON驱动模式 V4（specflow_v4.py）- A+升级版

**特点**：
- ✅ 支持JSON输入
- ✅ 支持三技能联动（01→02→35）
- ✅ 策略模式架构（8个独立生成器）
- ✅ Jinja2模板引擎
- ✅ 性能优化（模板缓存、list+join）
- ✅ 向后兼容V3（--legacy标志）
- ✅ 完整的数据验证

**使用场景**：
```bash
# 推荐：使用V4新版生成器
python specflow_v4.py -i "../02-architecture/ARCHITECTURE.json" -o "output_v4/"

# 使用V3旧版生成器（向后兼容）
python specflow_v4.py -i ARCHITECTURE.json -o output/ --legacy

# 指定文档深度
python specflow_v4.py -i ARCHITECTURE.json -o output/ --depth detailed
# 可选: minimal, standard, detailed
```

**V4优势**：
- 🏗️ **架构升级**: 不再是God Class，使用策略模式
- 🚀 **性能优化**: 模板缓存 + 字符串拼接优化
- 🔍 **数据验证**: 自动检查spec_model和arch_model完整性
- 🔧 **灵活降级**: 模板缺失时自动使用内置生成

---

## 三技能联动完整工作流

### 标准工作流（01→02→35）

```mermaid
graph LR
    A[01-spec-explorer] -->|DESIGN.json| B[02-architecture]
    B -->|ARCHITECTURE.json<br/>spec_model + arch_model| C[35-specflow JSON模式]
    C --> D[8个高质量规格文档]
```

### 步骤详解

#### 步骤1: 使用01-spec-explorer分析需求
```bash
cd ../01-spec-explorer
python spec_explorer.py --task "开发AI文档管理系统" --output DESIGN.json
```
**输出**: `DESIGN.json`（包含spec_model）

#### 步骤2: 使用02-architecture设计架构
```bash
cd ../02-architecture
python architecture_designer.py --input ../01-spec-explorer/DESIGN.json --output ARCHITECTURE.json
```
**输出**: `ARCHITECTURE.json`（包含spec_model + arch_model）

#### 步骤3: 使用35-specflow生成规格文档
```bash
cd ../35-specflow
# 使用V4（推荐）
python specflow_v4.py -i ../02-architecture/ARCHITECTURE.json -o output_v4/

# 或使用V3（稳定）
python specflow_json.py -i ../02-architecture/ARCHITECTURE.json -o output_v3/
```
**输出**: 8个规格文档
- `00-项目概览.md`
- `01-需求规格.md`
- `02-领域模型.md`
- `03-架构设计.md`
- `04-实施计划.md`
- `05-测试策略.md`
- `06-风险评估.md`
- `07-质量报告.md`

---

## JSON Schema要求

### 必需字段（三技能联动）

```json
{
  "meta": {
    "project_name": "项目名称",
    "generated_by": "01-spec-explorer | 02-architecture | 35-specflow"
  },
  "spec_model": {
    "flow_modeling": {
      "user_stories": [
        {
          "id": "US-001",
          "role": "企业文档管理员",
          "action": "上传文档",
          "goal": "集中管理文档",
          "priority": "High"
        }
      ]
    },
    "domain_modeling": {
      "entities": [
        {"name": "User", "attributes": [...], "relationships": [...]}
      ],
      "bounded_contexts": [...]
    },
    "bdd_scenarios": [
      {
        "feature": "文档上传",
        "scenario": "成功上传PDF文档",
        "given": ["用户已登录", "用户选择了一个PDF文件"],
        "when": ["用户点击上传按钮"],
        "then": ["系统显示上传成功消息", "文档出现在文档列表中"]
      }
    ]
  },
  "arch_model": {
    "scale_assessment": {...},
    "tech_stack": {...},
    "pattern_selection": {...}
  }
}
```

### 数据完整性验证

V4会自动验证JSON数据完整性：

```python
# V4自动检查
if 'spec_model' not in json_data:
    print("⚠️  警告: JSON缺少spec_model（来自01-spec-explorer）")

if 'arch_model' not in json_data:
    print("⚠️  警告: JSON缺少arch_model（来自02-architecture）")
```

---

## 常见问题（FAQ）

### Q1: 我应该使用哪个文件？

**答案**：
- **生产环境 + 三技能联动**: 使用 `specflow_v4.py`（推荐）或 `specflow_json.py`
- **快速原型**: 使用 `specflow.py`（不支持JSON）

### Q2: 为什么我的JSON文件报错？

**可能原因**：
1. 你使用了 `specflow.py`（规则引擎模式），它不支持JSON
   - **解决**: 改用 `specflow_v4.py` 或 `specflow_json.py`

2. JSON缺少必需字段（spec_model或arch_model）
   - **解决**: 确保使用完整的 `ARCHITECTURE.json`（来自02-architecture）

3. JSON格式不正确
   - **解决**: 使用 `python -m json.tool ARCHITECTURE.json` 验证JSON格式

### Q3: V3和V4有什么区别？

**V3 (specflow_json.py)**：
- 单一God Class架构
- 硬编码Markdown生成
- 字符串拼接性能较低
- 稳定可靠

**V4 (specflow_v4.py)**：
- 策略模式（8个独立生成器）
- Jinja2模板引擎支持
- 性能优化（缓存+list+join）
- 向后兼容V3（--legacy）
- 完整数据验证

**推荐**: 新项目使用V4，已有项目可继续使用V3或迁移到V4

### Q4: 如何验证V4是否工作正常？

```bash
# 1. 检查帮助信息
python specflow_v4.py --help

# 2. 使用测试JSON执行
python specflow_v4.py -i "../02-architecture/TEST_ARCH.json" -o "test_output/"

# 3. 验证输出
ls test_output/  # 应该看到8个.md文件
```

### Q5: V4的模板警告怎么办？

**警告示例**：
```
⚠️  模板文件不存在: C:\...\35-specflow\templates\overview.md.j2
```

**解决方案**：
1. **无需担心**: V4会自动降级到内置生成，文档仍会正常生成
2. **消除警告**: 创建Jinja2模板文件（可选，后续版本会提供）

---

## 命令速查表

### V4（推荐）

```bash
# 基础用法
python specflow_v4.py -i INPUT.json -o OUTPUT_DIR/

# 指定深度
python specflow_v4.py -i INPUT.json -o OUTPUT_DIR/ --depth detailed

# 使用V3兼容模式
python specflow_v4.py -i INPUT.json -o OUTPUT_DIR/ --legacy

# 查看帮助
python specflow_v4.py --help
```

### V3

```bash
# 基础用法
python specflow_json.py -i INPUT.json -o OUTPUT_DIR/

# 指定深度
python specflow_json.py -i INPUT.json -o OUTPUT_DIR/ --depth detailed

# 查看帮助
python specflow_json.py --help
```

---

## 输出文档说明

### 文档列表

| 文件名 | 说明 | 内容 |
|--------|------|------|
| `README.md` | 文档索引 | 项目信息 + 文档列表 |
| `00-项目概览.md` | 执行摘要 | 愿景、背景、指标、利益相关者 |
| `01-需求规格.md` | 需求详情 | 功能性需求、非功能性需求、用户故事 |
| `02-领域模型.md` | 领域建模 | 实体、关系、边界上下文 |
| `03-架构设计.md` | 技术架构 | 架构模式、技术栈、组件设计 |
| `04-实施计划.md` | 开发计划 | 迭代计划、里程碑、资源分配 |
| `05-测试策略.md` | 测试计划 | 测试层级、BDD场景、验收标准 |
| `06-风险评估.md` | 风险管理 | 风险识别、评估、缓解策略 |
| `07-质量报告.md` | 质量分析 | 质量指标、复杂度、估算工时 |

### 文档深度选项

- **minimal**: 最小化文档（快速交付）
- **standard**: 标准文档（推荐，默认）
- **detailed**: 详细文档（完整规格）

---

## 下一步行动

### 立即验证

```bash
# 1. 进入目录
cd C:\Users\bigbao\.claude\skills\35-specflow

# 2. 验证V4可用性
python specflow_v4.py --help

# 3. 使用测试JSON执行
python specflow_v4.py -i "../02-architecture/TEST_ARCH.json" -o "verification_test/"

# 4. 检查输出
ls verification_test/
cat verification_test/README.md
```

### 生产使用

```bash
# 使用你的实际JSON文件
python specflow_v4.py \
  -i "../02-architecture/YOUR_ARCHITECTURE.json" \
  -o "output_production/" \
  --depth standard
```

---

## 技术支持

### 问题反馈

如遇到问题，请提供以下信息：
1. 使用的命令
2. 完整的错误消息
3. JSON文件的meta信息
4. 生成日志

### 相关文档

- `诊断报告_JSON驱动模式可用性.md` - 详细诊断报告
- `UPGRADE_TO_A_PLUS.md` - V4升级计划
- `V4_IMPLEMENTATION_REPORT.md` - V4实现报告
- `tests/test_three_skills_integration.py` - 集成测试

---

**文档版本**: 1.0
**最后更新**: 2025-12-21
**维护者**: Claude Code Skills Team
